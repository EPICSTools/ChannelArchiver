\chapter{Changes}

This chapter describes the version numbers and changes since
the beginning of the R3.14 port.
New  "versions"  are  marked  by some additional functionality. The
"patches" are then used to debug those new things.

% Compare: make.cfg, ArchiveDaemon.pl $version
\begin{itemize}

\item 03/31/2005 --- Version 2.2.0:\\
Added a "Write Duration" status to the main
page of the Engine HTTPD.
It is a running average of the time spent
writing to the disk.
ExampleSetup includes a new script,
"engine\_write\_durations.pl",
which queries all engines for their write duration.
The intent is to get an idea of how much time
is spent doing disk I/O, and to get a grasp on
which engine is doing worst.

\item 03/21/2005 --- Version 2.1.9:\\
The ArchiveDaemon.pl script now creates a soft-link
"current\_index" in the engine subdirectories,
pointing to the currently used index.
The idea is to have a common name for the active index
in case the multi-index is broken or only updated
slowly.

The next issue was that the relation of an index
to its data files must not change.
If an index is in the same directory as its data files,
OK, but this soft link was actually in a different location,
so in order to still find the data files, the retrieval
now follows sym-links to index files on level deep
(not following arbitrary chains of soft links).

\item 02/01/2005 --- Version 2.1.8:\\
At the SNS, one ArchiveEngine running a configuration with
'disabling' channels tended to hang up just after a channel
'disabled' a group.
While I was never able to capture this in the debugger or
otherwise reproduce it, I did find a violation of the lock
order in the code related to 'disabling' a group, so this
might have been the reason.

\item 10/26/2004 --- Version 2.1.7:\\
In monitored mode, engine will always try to add two initial
samples: One with the original time stamp, one with the host
time stamp. This solves the restart problem:

Assume a setpoint PV is 3 days old. When we start an engine today,
it'll write that 3-day old value. When we then stop and restart tomorrow
in a new directory, a "Disconnected" value will be added before shutdown
and then the same happens in the new directory.
When now looking at both days, you would get the 3-day old value,
a disconnect/off value and nothing else.

With this update, you will see one value with the host's time stamp
each day in addition to the original time stamp, so even when viewed
via a master-index, one sample per day should be visible.

ArchiveDaemon.pl no longer complains about an undefined "opt\_i",
thanks to Paul Sichta for pointing this out.

\item 09/07/2004 --- Version 2.1.6:\\
Added Enable/Disable code to ArchiveDaemon.
``ListIndex'' bug fixes (sub-index was
closed even though we're still accessing channels in the index).

\item 08/26/2004 --- Version 2.1.5:\\
Fixed bug in the engine code: PVs which never change
were never written when sampling with period < get\_threshold.

Working on a ``ListIndex'', allowing the retrieval
tools to use an indexconfig.dtd-type list of
sub-archives, querying them one by one.
The result is slower than using a ``real'' index,
but much easier to setup and maintain.

\item 07/26/2004 --- Version 2.1.4:\\
Bug in DataReader that affected all the retrieval code:
The ``find'' uses the start time in an at-or-before sense,
which is intentional for direct calls to find().
This happened, too, when it was used internally for the purpose
of switching to a new data block ref'ed by a (master) index.
In that case, however, the start time given by the index must
be observed in an at-or-after sense, otherwise we can go
back in time.

Added the weekly option to the ArchiveDaemon.
Not detailed in manual until we get some milage on it.

\item 07/23/2004 --- Version 2.1.3:\\
Index update had a flaw:
When an engine stops, that last value received via CA
might have a time stamp of 10:00 and then we stop
at 11:00, so the last stored value is the ``off'' value
at 11:00.
When now a new engine starts, the first data is still
10:00, and that data is hidden under the last data block
of the previous engine (...11:00).
When then the new engine added more data, eventually
beyond 11:00, that new data stayed hidden unless
one rebuilt the master index from scratch.
Hopefully fixed this.

\item 06/30/2004 --- Version 2.1.2:\\
Added tags and channel names to the Data files,
so that in the future one could try to write
a rescue tool.
Patch for XML-RPC C/C++ lib.\ allows small numbers.
DataTools' ``index2dir'' option now actually works.
Matlab/Octave glue code can handle an array channel
(when requesting a single channel, raw data).
ArchiveDaemon generates indexupdate.xml for each re-index run;
``-u'' option.

When retrieval uses a "master" index and reaches
its end, it will try to continue by following
links of the last data block in the sub-archive.
This will allow us to get closer to "now" between
updates of the master index.
The first attempt to implement this failed because
of errors in the handling of the path names
(master index has path to data files, but when
we follow the links inside the sub-archive's data
file, those are relative to where the sub-archive resides).
Still not fully tested.

\item 04/01/2004 --- Version 2.1.1:\\
Many little updates have been checked into CVS
while the tools reported "2.1.1".
In the end, the engine supported sampling, monitoring
and sampling-based-on-monitors, and ran without known problems
under valgrind.
The XML-RPC Data Server seemed to work fine, supporting
raw data, plot-binning, spreadsheets, averaged and linear interpolation.
Java Archive client is useable.
Switched index file to CAI2, where the name hash includes a filename
for the RTree. For now it's left empty, but the file format now
allows for a further extension where certain RTrees are in separate
files as soon as the index file gets too big.

\item 01/27/2004 --- Version 2.1.0:\\
Uses new RTree, initial XML-RPC Data Server, XML configuration files.

\item 09/05/2003 --- Version 2.0.1:\\
Some bug fixes:
The  "scanned"  operation didn't work, and when all was monitored,
the  empty  scan lists lead to a high CPU load. Still not perfect,
the  ChannelInfo  code  should  be  split  into  really monitored,
scanned using CA monitor and scanned using CA get.

\item 04/04/2003 --- Version 2.0:\\
Starting to work on R3.14 port.
\end{itemize}
