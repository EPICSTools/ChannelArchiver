\chapter{Example Setup} \label{ch:examplesetup}
The following describes how the archiver toolset is used at the
\INDEX{Spallation Neutron Source (SNS)}. Other sites might need to
modify the tools in the ChannelArchiver/ExampleSetup directory for their
need.

For the SNS, every computer involved in archiving has a local directory ``/arch''.
On some computers, for example ics-srv-archive1, that directory
is used to run engines.
On another computer, for example ics-srv-web2, that same directory
contains data copied from archive1 so that the data server
can serve it.
The actual data might reside in different partitions,
which are accessed via soft-links from /arch.
There might be more than one 'sampling' computer as well as more
than one 'serving' computer.

We want to be able to move an engine from one computer to another,
and still keep an overview.
Therefore a file ``/arch/archiveconfig.xml'' describes the complete
archive setup: Which engines run where, and how the data gets served.
The next section descibes archiveconfig.xml in a bit more detail.
Further sections describe the scripts from ChannelArchiver/ExampleSetup
which we typically copy into ``/arch/scripts'' on all the involved computers.

\section{archiveconfig.xml}
\lstinputlisting[float=htb,keywordstyle=\sffamily,caption={archiveconfig.xml},label=lst:archiveconfig]{../ExampleSetup/archiveconfig.xml}

Each computer needs to have the same copy of /arch/archiveconfig.xml.
You might generate and distribute that file manually
or use a relational database.
People who have used previous releases of the archive toolset might
remember the archiveconfig.csv file. There is a tool
convert\_archiveconfig\_to\_xml.pl to convert that file
into an archiveconfig.xml skeleton.

\clearpage

In any case, archiveconfig.xml describes the complete archive layout,
using the following elements:
\begin{itemize}
\item root: Names the root directory, typically '/arch'.
      This has to be the same directory name on all computers,
      since they all use the same archiveconfig.xml.
\item mailbox: Used to communicate from the ArchiveDaemons to
      the data server. Has to be an existing directory where
      all involved computers can read and write, e.g.
      shared via NFS.
\end{itemize}

update\_archive\_tree.pl

\section{ArchiveDaemon}

ArchiveDaemon.dtd
ArchiveDaemon.pl
ArchiveDaemon.xml

start\_daemons.pl
stop\_daemons.pl

\subsection{Status Information}
engine\_write\_durations.pl
make\_archive\_infofile.pl
make\_archive\_web.pl

show\_engines.pl
show\_sizes.pl

\section{Indices}
update\_indices.pl

\section{Data Server}
update\_server.pl


ALL THE REST NEEDS TO BE REVIEWED!



A file ``\INDEX{archiveconfig.csv}'' describes the top-level layout:
 
\begin{lstlisting}[frame=none,keywordstyle=\sffamily]
# Archive configuration file
# This is TAB delimited!
# Careful when editing, do not disturb the TABs,
# because this file fails to parse unless
# everything is perfect.

# Type Name Port Desc       Restart  Time
DAEMON ICS  4090 ICS Daemon
ENGINE tim  4091 Timing     daily    08:00
ENGINE mps  4092 Mach.Prot. daily    08:30

DAEMON RF   4900 RF
ENGINE llrf 4901 LowLvl.    weekly   We 10:20
ENGINE hprf 4902 HiPwr.     weekly   We 10:30
\end{lstlisting}

\noindent This reads as follows:
We intend to run one ``ArchiveDaemon'' for the Integrated Control
System (ICS) and one for the channels related to Radio Frequency (RF).
ArchiveDaemon, described in full detail in chapter \ref{ch:daemon},
starts archive engines and monitors their operation. The ICS daemon
should maintain one ArchiveEngine for the timing system (tim) and one
for the machine protection system (mps), while the RF daemon has one
engine for the low-level and one for the high power RF (llrf, hprf).

This separation is somewhat arbitrary. We could have made ``llrf'' and
``hprf'' channel groups under one and the same engine. In fact all the above
could reside within one engine. It is, however, advisable to spread the channels
over different daemons and engines whenever different people deal with
the IOCs that host the channels, so that the engineers can
independently configure their archiving. 
In addition, you want to keep the amount of data collected by each
engine within certain bounds, for example: not more than one CD ROM
per month, one DVD per year, or whatever you plan to do for data
maintenance. Another reason is data safety: You can reduce the damage
caused by crashes of the engine by limiting the number of channels per engine.

\section{Current Archive Status} \label{sec:makearchweb}
The perl script ``\INDEX{make\_archive\_web.pl}'' creates a web page
displaying the current status of all the archive daemons and engines
that are listed in the file ``archiveconfig.csv''
(you could use other names for the main configuration file, but we
will stick with ``archiveconfig.csv'' in this manual).
For the SNS, this script is periodically executed with the result being
redirected into the web server's document tree, so you can usually
reach the recent status from this web page:
\begin{lstlisting}[frame=none,keywordstyle=\sffamily]
    http://ics-srv-archive1/archive
\end{lstlisting}
\noindent  Fig.~\ref{fig:archcfgstat} shows one example of that web
page: A tabular display of what engines are running, how many channels are
connected, and more.

\medskip

\begin{figure}[htb]
\begin{center}
\InsertImage{width=\textwidth}{archcfgstat}
\end{center}
\caption{\label{fig:archcfgstat}Example of the archive status web page
  generated by the make\_archive\_web.pl script.}
\end{figure}

\section{Directory Layout}
The perl script ``\INDEX{make\_archive\_dirs.pl}'' creates or updates a
directory tree based on the file ``archiveconfig.csv''. For the preceding
example, it would create subdirectories ``ICS'' and ``RF'' for the two
daemons, plus the following engine directories:
\begin{lstlisting}[frame=none,keywordstyle=\sffamily]
  ICS/tim
  ICS/mps
  RF/llrf
  RF/hprf
\end{lstlisting}
\noindent Each daemon directory contains a daemon configuration file
as well as start/stop scripts. Each engine directory contains a script
to stop the engine. Note the absence of a script to start the engine:
You should not manually start engines which are under the control of
an archive daemon.  Each engine directory also contains an
``ASCIIConfig'' subdirectory with a script ``convert\_example.sh''
that you might use to create the XML configuration file for the
ArchiveEngine from ASCII configuration files, though the engineer
responsible for the subsystem is free to use any method of his/her
choice as long as the result is a configuration file for the engine
that follows the naming convention
\begin{center}
{\it Daemon-Name} / {\it Engine-Name} / {\it Engine-Name}-group.xml~,\\
\end{center}
resulting in these for our example:
\begin{lstlisting}[frame=none,keywordstyle=\sffamily]
  ICS/tim/tim-group.xml
  ICS/mps/mps-group.xml
  RF/llrf/llrf-group.xml
  RF/hprf/hprf-group.xml
\end{lstlisting}
As long as you end up with engine configuration files of these names,
you can employ any text editor, a copy of the example script, or a
sophisticated toolset utilizing a relational database.
If you want to use the ASCIIConfig directory, check section
\ref{sec:ASCIIConfig} for the format of the ASCII configuration files.

\section{Sub-Archives}
Based on the configuration from the beginning of this chapter,
the daemon will 
\begin{enumerate}
\item Start an ArchiveEngine in ``RF/llrf'' that writes to
      a sub-archive named after the current day,
      e.g.\ ``RF/llrf/2004/02\_11/index''.
      Same for a second engine in ``RF/hprf''.
\item Periodically verify if engines that are supposed to run are
      actually running, attempting to start engines which are found missing.
\item Stop the ArchiveEngines each Wednesday at 10:20 respectively
      10:30 and restart them in new subdirectories
      (using the data of the restart for the path to the index file).  
\item Generate or update ``RF/indexconfig.xml'' whenever a new
      sub-archive is created for the vacuum or cooling data.
\item Periodically run ArchiveIndexTool on ``RF/indexconfig.xml'',
      generating or updating ``RF/master\_index''.
\item Provide a web page that lists the status of the two archive
      engines.
\end{enumerate}

\noindent As a result, we create separate sub-archives for the LLRF
and HPRF, a new one once per week, which provides some insurance
against crashes of an ArchiveEngine. If you are paranoid, you can
choose daily sub-archives; compare the ICS setup from the beginning of
chapter \ref{ch:examplesetup}.
After running for a while, we will have created sub-archives like these:
\begin{lstlisting}[frame=none,keywordstyle=\sffamily]
  RF/llrf/2004/02_11/index
  RF/llrf/2004/02_18/index
  RF/llrf/2004/02_25/index
  ...
  RF/hprf/2004/02_11/index
  RF/hprf/2004/02_18/index
  RF/hprf/2004/02_25/index
  ...
\end{lstlisting}
\noindent In addition to each index file, there will of course also be
associated data files, but for retrieval purposes we identify an
archive solely by its index file: We can invoke e.g.\ ArchiveExport
with the path to any of the index files. This is, however,
inconvenient because we will only see data for one week of that one
subsystem at a time. The periodic invocation of the ArchiveIndexTool
allows us to view all the RF data as a whole via the RF/master\_index.

\subsection{ArchiveDaemon Details}
The ``Restart'' and ``Time'' columns of the ``archiveconfig.csv'' file
are passed on to the ArchiveDaemon, which is explained in more detail
in chapter \ref{ch:daemon}. In many cases it might be sufficient to
know these two options:
\begin{itemize}
\item Restart=``daily'', Time set to the time of day in 24-hour
      format HH:MM, e.g.\ 08:00 for 8'o clock in the morning.
      The daemon will stop and restart the engine in a new sub-archive
      each day at the given time.
\item Restart=``weekly'', Time set to a string that combines the day
      of the week (Mo, Tu,  We, Th, Fr, Sa, Su) with the time of day in 24-hour
      format into ``DD HH:MM'', e.g.\ ``We 08:00'' for Wednesdays, 8'o
      clock in the morning. Similar to the daily setup, but reduced to
      once a week.
\end{itemize}
\noindent It is advisable to stagger the restart times of your engines
such that they don't all restart at the same day and time in order to
reduce the CPU and network load for the ChannelAccess re-connects.

\section{Common Tasks}

\subsection{Check Daemon, Engine, Connected Channels, ...}
See section \ref{sec:makearchweb}. That web page links to all
the ArchiveDaemons, which in turn link to all the ArchiveEngines.

\subsection{Modify Engine's Request Files}
Locate your archive engine on either the main archive status page
(section  \ref{sec:makearchweb}) or in /arch/archiveconfig.csv.
According to the example at the beginning of this chapter, the ``High
Power RF'' engine would be run by the ``RF'' daemon and be called
``hprf'', so we need to modify /arch/RF/hprf/hprf-group.xml.
This is often done via a conversion script in
/arch/RF/hprf/ASCIIConfig. If you used another method to create the
engine configuration, this is a good time to remember what you did.

Then, to actually use that new config file, the engine needs to
restart. We could simply wait for the next scheduled restart, in our
example the next Wednesday, 10:30. Alternatively, we can run the
script /arch/RF/hprf/stop-engine.sh.
Watch the RF daemon via the link on the main archive status page.
Within a few minutes, it ought to detect that the engine had stopped
and then restart it.

\subsection{Add Engine or Daemon}
Add a line to archiveconfig.csv to define the new engine under an
existing demon. Or add a line for a new daemon, then add the new
engine under it. Invoke  make\_archive\_dirs.pl. Per default, it will
re-create all daemon and engine directories, so you might want to use
the ``-s'' option to limit its operation to the new or modified
subsystem.
In case the daemon was already running, it won't learn about the new
engine unless you restart it. So run the ``stop-deamon.sh'' and then
invoke the ``run-daemon.sh'' script in the daemon directory to start
the daemon (which will then start any missing engines).

\subsection{An Engine isn't running}
Check the process list to assert that the engine in question is really not
running (on UNIX, try ``ps -aux''). Look again. If the engine is
actually running but not responding via its HTTPD, remove the process.
Check the log file of the engine, generated in the engine
subdirectory, for any clues. If you are convinced that the engine is
not running, but find an ``archive\_active.lck'' lock file in the
engine directory, remove it. Now the daemon should be able to start
your engine.  

\subsection{I want to stop a Daemon}
Run stop-daemon.sh in the daemon directory, or check chapter
\ref{ch:daemon} for more on the daemon's HTTPD.

\subsection{A Daemon isn't running}
Run start-daemon.sh in the daemon directory. If the daemon keeps quitting,
check its log file for clues.

\subsection{Re-building a Master Index}
Whenever you add or remove a sub-archive, the master index in the
daemon directory could be obsolete: It might still list data in a
sub-archive that you removed, or it might not yet include the new
sub-archive. Another szenario: you suspect that the master index is
broken, because you can retrieve data from the individual sub-archive
but not via the master index. The recipe:
\begin{itemize}
\item Stop the daemon
\item Check, maybe rebuild indexconfig.xml, either manually or by
  using the helper script make\_indexconfig.pl
  (see section  \ref{sec:makeindexconfig}).
\item Start the daemon, which causes it to invoke the ArchiveIndexTool.
\end{itemize}

\section{Data Management}
The generation of daily sub-archives reduces the amount of data that
might be lost in case an ArchiveEngine crashes and cannot be restarted
by the ArchiveDaemon to one day. In the long run, however, it is
advisable to combine the daily sub-archives into bigger ones, for
example monthly. The smaller number of sub-archives is easier to
handle when it comes to backups. Is also provides slightly better
retrieval times. Depending on your situation, monthly archives might either
be too big to fit on a CD-ROM or ridiculously small, in which case you
should try weekly, bi-weekly, quarterly or other types of sub-archives.

In the following example, we assume that it's March 2004 and we want
to combine the two daily vacuum sub-archives from the previous section
into one for the month of February 2004:
\begin{lstlisting}[frame=none,keywordstyle=\sffamily]
cd vacuum/2004
mkdir 02_xx
ArchiveDataTool -copy 02_xx/index 02_19/index \
    -e "02/20/2004 02:00:00"
ArchiveDataTool -copy 02_xx/index 02_20/index \
    -s "02/20/2004 02:00:00" -e "02/21/2004 02:00:00"
\end{lstlisting}
\noindent Note that we assume a daily restart at 02:00 and thus we
force the ArchiveDataTool to only copy values from the time range
where we expect the sub-archives to have data. This practice somewhat
helps us to remove samples with wrong time stamps that result from
Channel Access servers with ill-configured clocks.

There is a perl command \INDEX{make\_compress\_script.pl} that aids in the
creation of a shell script for the ArchiveDataTool, but you need to
review it carefully before invokation.
After successfully combining the daily sub-archives for February 2004
into a monthly 2004/02\_xx, we need to
\begin{enumerate}
\item Stop the ArchiveDaemon because we are about to edit
      indexconfig.xml.
      The ArchiveEngines controlled by the daemon can run on.
\item Edit indexconfig.xml that listed the daily sub-archives for
      Feb.\ 2004 and replace them with the single 2004/02\_xx/index.
\item Remove or rename the master index file and re-create it with the new
      indexconfig.xml. This step is required because the ArchiveIndexTool
      will only add new data blocks to the master index, it will not
      remove existing ones. Since we no longer want to refer to the
      daily sub-archives, we need to recreate the master index.
\item Start the ArchiveDaemon again, check its online status.
\item One may now move the daily sub-archives that are no longer
      required to some temporary location. A month later, when we are
      convinced that nobody is still trying to use them, we can delete
      them.
\end{enumerate}

\noindent Again there is no tool available to automate the
indexconfig.xml update.
