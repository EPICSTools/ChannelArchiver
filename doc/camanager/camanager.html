<!doctype HTML public "-//W3O//DTD W3 HTML 3.0//EN">

<html>

  <head>
    <title>Channel Archive Manager</title>
    <link REL="STYLESHEET" HREF="../style.css" TYPE="text/css">
  </head>

  <body background="../blueback.jpg">
      <h1>Channel Archive Manager</h1>
      <p>
	This is a simple frontend to the ChannelArchiver.
      </p>
      <p>
	It manages and observes <em>ArchiveEngine</em> processes and their
	corresponding directories.
      </p>

      <h2>Contents</h2>
      <ul>
	<li><a href="#synopsis">Synopsis</a> - command line invocation and arguments
	  <ul>
	    <li><a href="#options">Options</a> - list of options</li>
	  </ul>
	</li>
	<li><a href="#CAManager">CAManager</a> - The <em>CAManager</em> frontend (tcl/TK GUI)
	  <ul>
	    <li><a href="#creat">Creating/Configuring an Archiver</a></li>
	    <li><a href="#edit">Editing an ArchiveEngine configuration file</a></li>
	    <li><a href="#block">Blocking an archiver</a> - from being started/restarted/stopped automatically</li>
	    <li><a href="#info">Info</a> - get basic information for an archive</li>
	    <li><a href="#test">Test</a> - test integrity of an archive </li>
	    <li><a href="#export">Export</a> - export data from an archive</li>
	    <li><a href="#modify">Modify</a> - rename/delete channels in an archive</li>
	  </ul>
	</li>
	<li><a href="#CAbgManager">CAbgManager</a> - The backend that starts/restarts archivers
	  <ul>
	    <li><a href="#blocked">Blocked Archivers</a> - what happens if an archiver is blocked</li>
	    <li><a href="#commands">Commands</a> - commands available in the web-interface</li>
	  </ul>
	</li>	
	<li><a href="#cycling">Cycling Archives</a> - reuse a certain number of
	  archives in a round robin way</li>
	<li><a href="#plugins">Plugins</a> - define own tcl-functions to be
	  used in <em>CA*Manager</em>
	  <ul>
	    <li><a href="#xmpplugin">example caget plugin</a></li>
	  </ul>	
	</li>
	<li><a href="#problems">Help when Problems occur</a> - A way to get more
	  verbose output, that may help tracking down a problem</li>
      </ul>

      <h1><a name="synopsis">Synopsis</a></h1>
      <pre>
    CAManager [-log &lt;logfile&gt;] [-log+ &lt;logfile&gt;] [&lt;cfg-file&gt;]

    CAbgManager [-log &lt;logfile&gt;] [-log+ &lt;logfile&gt;] [-nocmd] [&lt;cfg-file&gt;]
      </pre>

      <h2>Options</h2>

      <table border=0 cellspacing=20>
	<tr>
	  <td width="20%" valign=top><tt>-log&nbsp;&lt;logfile&gt;<br>-log+&nbsp;&lt;logfile&gt;</tt></td>
	  <td width="80%" valign=top>
	    A log of important messages is written to &lt;logfile&gt;.
	    If &lt;logfile&gt; is <tt>-</tt>, the messages are written to stdout.
	    The environment-variable <tt>CAMANAGER_DEBUG</tt> can be set to increase 
	    verbosity (see <a href="#problems">Help when Problems occur</a>).
	  </td>
	</tr>
	<tr>
	  <td valign=top><tt>-nocmd</tt></td>
	  <td valign=top>
	    Use this option to switch off the commnd-buttons of the web-interface of 
	    <em>CAbgManager</em>.
	  </td>
	</tr>
	<tr>
	  <td valign=top><tt>&lt;cfg-file&gt;</tt></td>
	  <td valign=top>
	    <p>
	      You can specify a cfg-file to load instead of the default cfg-file.
	    </p>
	    <p>
	      If no file with the given name can be found (absolute or relative to 
	      the current directory), actions are performed according to the
	      following rules:
	    </p>
	    <ul>
	      <li>
		if a filename with a directory component is given and the
		directory exists (absolute or relative to either the current
		directory or the directory <tt>$HOME/.CAManager</tt> (UNIX only!)),
		the new file is created in the specified place
	      </li>
	      <li>
		if just a plain filename is specified, a new file is created in the
		directory <tt>$HOME/.CAManager</tt><br>
		<b>Note:</b> A file with the given name found in the current directory
		has precedence!
	      </li>
	      <li>
		if the filename has a directory component that does not exist
		(absolute or relative to either the current directory or the
		directory <tt>$HOME/.CAManager</tt>) an error is produced and the
		program terminates
	      </li>
	    </ul>
	    <p>
	      If no filename is given, the default is assumed. Defaults are:
	    </p>
	    <ul>
	      <li><b>Unix/Linux-Systems:</b> <tt>$HOME/.CAManager/archivers</tt></li>
	      <li><b>Windows&reg;-Systems:</b> the Windows-Registry (indicated as 
		&lt;Registry&gt; in the statusbar of the main window of <em>CAManager</em></li>
	    </ul>
	  </td>
	</tr>
      </table>
      <p>
	Any occurance of <em>CA*Manager</em> in this documentation means,
	that the described functionality is covered by both
	<em>CAManager</em> and <em>CAbgManager</em>.
      </p>

      <hr noshade size=1>
      <img align=right src="main.jpg" width=377 height=141 hspace=8 vspace=8>
      <a name="CAManager"><h1>CAManager</h1></a>
      <p>
	The main frontend.
      </p>
      <p>
	<em>CAManager</em> is a GUI Application, that enables you to
	configure and start/stop <em>ArchiveEngine</em> processes. You can
	also configure the properties of the
	ArchiveEngine. <em>CAManager</em> also provides simple interfaces
	to the applications <em>ArchiveManager</em> and
	<em>ArchiveExport</em>, so you have access to the following
	functions/tools.
      </p>
      <ul>
	<li><a href="#creat">Creating/Configuring an Archiver</a>
	<li><a href="#edit">Editing an ArchiveEngine configuration file</a>
	<li><a href="#block">Blocking an Archiver</a> - from being started/restarted/stopped automatically
	<li><a href="#info">Info</a> - get basic information for an archive
	<li><a href="#test">Test</a>- test integrity of an archive
	<li><a href="#export">Export</a> - export data from an archive
	<li><a href="#modify">Modify</a> - rename/delete channels in an archive
      </ul>
      <hr noshade size=1>
      <img src="prop.jpg" width=200 height=287 align=right hspace=8 vspace=8>
      <a name="creat"><h2>Creating/Configuring an Archiver</h2></a>
      <p>
	A double-click on an archiver (an entry of the table in the main
	screen) opens the configuration-dialog. If you create a new
	archiver, the configuration-dialog also opens automatically.
      </p>
      <p>
	If the archiver you are configuring is currently running, some of
	the configurable properties in the dialog are disabled.
      </p>
      <p>
	A button with three dots in it opens a file-selection dialog. Most
	other string entries have a list of suggestions and settings
	attached to it.
      </p>
      <p>
	The space below the Run/Rerun configuration option changes it's
	contents according to the selected Run/Rerun scheme.
      </p>
      <p>
	You have to configure the following properties:
      </p>
      <hr noshade size=1>
      <dl>
	<dt><b>Host</b></dt>
	<dd>The host on which the ArchiveEngine should run.</dd>
      <hr noshade size=1>
      <dt><b>Port</b></dt>
      <dd>The portnumber for the ArchiveEngine web interface<br>
	<b>You have to ensure, that there are no collisions with other
	  applications using the same port!</b></dd>
      <hr noshade size=1>
      <dt><b>Configuration-file</b></dt>
      <dd>The <em>main</em> configuration file containing
	archiving-parameters and channel names as well as <tt>!group</tt>
	statements to include other files.<br>
	<b>This parameter has to be a full pathname (starting with a "<tt>/</tt>"
	  or e.g. "<tt>C:/</tt>" resp.)</b></dd>
      <hr noshade size=1>
      <dt><b>Schedule</b></dt>
      <dd><p>The <em>CAbgManager</em> is able to stop and restart archivers based on
	  a certain schedule.
	</p><p>
	  This is especially useful, if you automatically want archives
	  to be switched e.g. every week. In this case, set the
	  Run/Rerun mode to <tt>week</tt>, select the appropriate
	  weekday and time, when archives should be switched and set
	  the Archive-file configuration option to e.g. "<tt>%Y/%V/directory</tt>".
	</p><p>
	  In this case the archiver would create one archive per week
	  in a directory named
	  <tt>[year]/[weeknumber]/directory</tt>. This directory will
	  also be added to a <em>Multi-Archive</em> directory file in the
	  directory of the main configuration file which may then
	  e.g. look like this for an archiver rerun daily:</p>
	<pre>
master_version=1
/home/birke/Archives/another example/2001/10/09/directory
/home/birke/Archives/another example/2001/10/08/directory
/home/birke/Archives/another example/2001/10/07/directory
/home/birke/Archives/another example/2001/10/06/directory
/home/birke/Archives/another example/2001/10/05/directory
/home/birke/Archives/another example/2001/10/04/directory
...
	</pre>
	<p>
	  This <em>Multi-Archive</em> directory file can then be used
	  to access the whole archive at once.
	</p></dd>
      <hr noshade size=1>
      <dt><b>disable configuration changes ...</b></dt>
      <dd>Check this flag if you want to disable the online configuration
	interface of the <em>ArchiveEngine</em>. This is especially
	useful to avoid conflicting changes, if you create your
	configuration from a different source.</dd>
      <hr noshade size=1>
      <dt><b>check online configuration changes into cvs</b></dt>
      <dd><p>If this option is checked and a CVS directory exists in the main
	archiver directory, <em>CA*Manager</em> will check configuration
	changes into the CVS repository.</p><p><b>Note:</b><br>As this
	cvs-operation is executed without any user-interaction, you are
	advised to make shure that it won't hang e.g. asking for a
	password!</p></dd>
      <hr noshade size=1>
      <dt><b>force remove of bogus lockfile</b></dt>
      <dd><p>If an archiver cannot be started because of an existing lockfile,
	  <em>CA*Manager</em> can delete this lockfile after three unsuccessful
	  tries.</p><p>These lockfiles can e.g. be leftovers of a crashed
	  ArchiveEngine (which should of course not happen ;-) or even a
	  system crash.</p><p>Nevertheless deleting the lockfile is
	  something that should be well considered.</p></dd>
      <hr noshade size=1>
      <dt><b>Archive-file</b></dt>
      <dd>
	<p>This is the name of the archive directory file - the central
	  register of what is archived in this archive. This parameter
	  shouldn't be an abslolute pathname but a filename relative to the
	  directory of the configuration file.
	</p>
	<p>
	  The filename may contain directory components as well, but
	  shouldn't start with a "<tt>/</tt>".
	</p>
	<p>
	  It may also contain special components (starting with a
	  "<tt>%</tt>") that are replaced by strings depending on the current time.
	</p>
	<p>These components are:</p>
	<table>
	  <tr><th align=left valign=top>%Y</th><td>current year (e.g. 2001)</td></tr>
	  <tr><th align=left valign=top>%m</th><td>current month (e.g. 10)</td></tr>
	  <tr><th align=left valign=top>%B</th><td>abbreviated name of the current month (e.g. October)</td></tr>
	  <tr><th align=left valign=top>%b</th><td>abbreviated name of the current month (e.g. Oct)</td></tr>
	  <tr><th align=left valign=top>%V</th><td>current weeknumber (e.g. 41)</td></tr>
	  <tr><th align=left valign=top>%d</th><td>day of month (e.g. 09)</td></tr>
	  <tr><th align=left valign=top>%p</th><td>AM or PM</td></tr>
	  <tr><th align=left valign=top>%H</th><td>hour (24h format)</td></tr>
	  <tr><th align=left valign=top>%I</th><td>hour (12h format)</td></tr>
	  <tr><th align=left valign=top>%M</th><td>minute</td></tr>
	  <tr><th align=left valign=top>%S</th><td>second</td></tr>
	  <tr><th align=left valign=top>%%</th><td>a single percent sign</td></tr>
	  <tr><th align=left valign=top>...</th><td>(see <tt>man strftime</tt> for details)</td></tr>
	</table>
	<p>
	  A component consisting of a "<tt>%</tt>" followed by a number has
	  a special meaning (see <a href="#cycling">cycling archives</a>).
	</p>
	<p>
	  Another possibility is, to embed tcl-function calls in a
	  component like "<tt>%{function args}</tt>". The component will
	  then be replaced by the string returned by the function
	  called. This way you can embed almost everything in this
	  configuration parameter, especially, if you use the possibility
	  to define <a href="#plugins">plugins</a>.
	</p>
	<p>
	  If this parameter contains a directory-component that is
	  different from the current directory, <em>CA*Manager</em> will
	  create the appropriate directories before starting the
	  archiver. As the archiver
	  terminates all configuration files are copied from the
	  temporary directory, where <em>ArchiveEngine</em> puts online
	  changes, into the
	  main configuration directory and (if a directory named
	  <tt>CVS</tt> is available) checked into <em>cvs</em>
	  automatically to make online configuration changes persistent.
	</p></dd>
      <hr noshade size=1>
      <dt><b>Multi-Archive-file</b></dt>
      <dd>
	<p>
	  After an archiver is started, <em>CA*Manager</em> can add an
	  appropriate line to another Multi-Archive.
	</p>
	<p>
	  Several archivers may share a single Multi-Archive. The entries
	  in the Multi-Archive are made in the same order, in which the
	  archivers appear in the configuration window.
	</p>
      </dd>
      <hr noshade size=1>
      <dt><b>Log-file</b></dt>
      <dd><p>The ArchiveEngine logs it's output to this file.</p>
	<p>This should also be a filename relative to the directory of
	  the configuration file.</p>
	<p>"<tt>%</tt>"-rules are applied like with the Archive-file option.</p></dd>
    </dl>
      <hr noshade size=1>
      <img src="edit1.jpg" width=292 height=192 align=right hspace=8 vspace=8>
      <a name="edit"><h2>Editing an ArchiveEngine configuration file</h2></a>
      <p>
	Clocking and holding the right mouse button over an archiver entry
	pops up a menu where you can select <tt>View/Edit Configuration</tt>.
      <br>
	Do so and a new window will popup, where you can see and edit the
	main configuration file. Included configuration files can be
	clicked and the contents of the window will change to the contents
	of the selected file.
      </p>
      <hr noshade size=1>
      <a name="block"><h2>Blocking an archiver</h2></a>
      <p>
	When an archiver that is supposed to run terminates (either
	intentionally or not), the archiver is automatically restarted by
	<a href="#CAbgManager"><em>CAbgManager</em></a>.<br> In certain cases,
	you might want to prevent this archiver from being restarted
	(e.g. for reconfiguration, during a special shutdown...).
      </p><p>
	In this case you may <em>block</em> such an archive. Just popup the
	functions-menu by clicking and holding the right mouse button and
	select <tt>Block/Unblock</tt> from the list.<br>See <a
	href="#blocked">CAbgManager / Blocked Archivers</a> for further
	details.
      </p>
      <hr noshade size=1>
      <a name="info"><h2>Info</h2></a>
      <p>
	A simple frontend to the command
      </p>
      <pre>
    ArchiveManager -info &lt;archive&gt;
      </pre>
      <p>
	The info-command counts the number of channels in the archive and prints
	the min and max timestamps in the archive.
      </p>

      <hr noshade size=1>
      <a name="test"><h2>Test</h2></a>
      <p>
	A simple frontend to the command
      </p>
      <pre>
    ArchiveManager -test &lt;archive&gt;
      </pre>
      <p>
	The test-command test an archive for errors.
      </p>

      <hr noshade size=1>
      <img src="export.jpg" align=right width=296 height=288 hspace=8 vspace=8>
      <a name="export"><h2>Export</h2></a>
      <p>
	A simple frontend to the commands
      </p>
      <pre>
    ArchiveManager -xport [new archive] ...
      </pre>
      <p>
	for exporting to another archive, or
      </p>
      <pre>
    ArchiveExport ...
      </pre>
      <p>
	for exporting to a spreadsheet/matlab/gnuplot-file.
      </p>
      <p>
	The first version <em>Exporting to another archive</em> can be used to 
      </p>
      <ul>
	<li>extract a certain slice from an archive (by channel or by time or both)</li>
	<li> merge an archive into another one</li>
      </ul>
      <p>
	The second version is mainly for further processing with e.g. Excel,
	Origin, Matlab...
      </p>

      <a name="modify"><h2>Modify</h2></a>
      <p>
	A simple interface to the rename and delete functions of ArchiveManager.
      </p>
      <p>
	With this feature you can rename a channel in the archive or delete
	a channel from the archive (removing the directory entry).
      </p>
      <p>
	This way, you can rename channels in the archive by copying <em>old
	  channel</em> to <em>new channel</em> and deleting <em>old
	  channel</em> afterwards.
      </p>

      <hr noshade size=1>
      <img src="bgmanager.jpg" width=317 height=307 align=right hspace=8 vspace=8>
      <a name="CAbgManager"><h1>CAbgManager</h1></a>
      <p>
	This process has no GUI and doesn't produce output.
      </p>
      <p>
	It reads the current configuration and starts/stops/restarts
	<em>ArchiveEngines</em> after preparing the appropriate directories.
      </p>
      <p>
	The actions of <em>CAbgManager</em> and the status of configured
	<em>ArchiveEngines</em> can be observed via a web-page
	(http://&lt;hostname&gt;:&lt;port&gt;/) where port defaults to
	4610. The port-setting can be configured in the <em>CAManager</em>
	Edit/Preferences dialog.
      </p>
      <p>
	Configuration is re-read as it changes and jobs are rescheduled to match
	the new configuration.
      </p>
      <p>
	The port-setting applies on restart of the <em>CAbgManager</em>.
      </p>
      <p>
	By default <em>CAManager</em> automatically checks for a running <em>CAbgManager</em>.
      </p>

      <hr noshade size=1>
      <a name="blocked"><h2>Blocked Archivers</h2></a>
      <p>
	The <em>CAbgManager</em> starts every configured archiver, that is
	supposed to run as long as the archiver is not blocked. If it is
	blocked and hence the <em>CAbgManager</em> can't restart it. A
	corresponding message is appended to the action-log.
      </p>

      <hr noshade size=1>
      <a name="commands"><h2>Commands</h2></a>
      <p>
	The web-interface of <em>CAbgManager</em> can be used to start or
	stop archivers.<br>
	These start and stop actions automatically unblock (start) or block
	(stop) the automatic restart of an archiver.
      </p>
      <p>
	If you query the page "http://&lt;hostname&gt;:&lt;port&gt;/exit",
	the <em>CAbgManager</em> terminates.
      </p>
      <hr noshade size=1>
      <a name="cycling"><h1>Cycling Archives</h1></a>
      <p>
	If a "<tt>%</tt>" followed by a number appears in the archive-file configuration
	parameter of an archiver, this archive recieves special treatment.
      </p>
      <p>
	The corresponding archive is <em>cycled</em>, that means a certain
	number (the number after the "<tt>%</tt>") of archives is used like
	a circular buffer of archives.
      </p>
      <dl>
	<dt><b>Example</b></dt>
	<dd>
	  <p>
	    Assume the archive-file parameter is <tt>%3/directory</tt> and the
	    configuration-file parameter is
	    <tt>/some/dir/archive/config</tt>.
	    The schedule-mode should be <tt>hour</tt> set to
	    <tt>06:00:00</tt> every 8 hours.
	  </p>
	  <p>
	    That way actually three different archives</p>
	    <pre>
	    /some/dir/archive/0/directory
	    /some/dir/archive/1/directory
	    /some/dir/archive/2/directory
            </pre>
	  <p>
	    will be used.
	  </p>
	  <p>
	    One will be used from 6am to 2pm, the next one from 2pm to 10pm
	    and the last one from 10pm to 6am. The next <em>shift</em> from
	    6am to 2pm will then overwrite the first one...
	  </p>
	  <p>
	    The Multi-Archive files will be updated accordingly.
	  </p>
	</dd>
      <hr noshade size=1>
      <a name="plugins"><h1>Plugins</h1></a>
      <p>
	You may put any number of files (named <tt>*.tcl</tt>) containing
	tcl-functions into the directory <tt>CAManager/libsrc/plugins</tt>
	in the source-tree. These will automatically be installed when
	installing the <em>CAManager</em>.
      </p>
      <p>
	These plugins can be used e.g. in %-substitutions to determine the
	name of a new archive dynamically.
      </p>
      <h2><a name="xmpplugin">example caget plugin</a></h2></a>
      <p>
	As an example <em>CAManager</em> comes with a "caget"-plugin, that simply
	calls the external program "caget" with the supplied arguments and
	returns the output-value of the program call.
      </p>
<pre>
	proc caget {pv} {
	  return [exec caget -t $pv]
	}
</pre>
      <p>
	<b>Example:</b><br>
	A configuration value of
	"<tt>archives/%{caget&nbsp;somePV}/directory</tt>" will result in
	archives put into directories named by the value of the PV
	<tt>somePV</tt> at the time the archive is created.
      </p>
      <hr noshade size=1>
      <a name="problem"><h1>Help when Problems occur</h1></a>
      <p>
	If the Environment-Variable <B><TT>CAMANAGER_DEBUG</tt></b> is set
	during startup of <em>CAbgManager</em>, <em>CAbgManager</em> will
	create more verbose output in its log.  The value of the
	Environment-Variable should be an integer value, that represents a
	bitmap:
      </p>
      <div align=center>
	<table border=1><tr><th>Bit #</th><th>Bit value</th><th>Debug-messages</th></tr>
	  <tr><td>0</td><td>1</td><td>Scheduler messages</td></tr>
	  <tr><td>1</td><td>2</td><td>debug-messages - level 1</td></tr>
	  <tr><td>2</td><td>4</td><td>debug-messages - level 2 (also implies Bit# 1)</td></tr>
	  <tr><td>3</td><td>8</td><td>function-calls</td></tr>
	  <tr><td>4</td><td>16</td><td>function calls of heavily called functions (also implies Bit#3)</td></tr>
	  <tr><td>5</td><td>32</td><td>further console messages</td></tr>
	</table>
      </div>
      <p>
	Just sum up the appropriate Bit values to get the corresponding messages.
      </p>
      <p>
	<b>Note:</b> Debug messages for for Bit # 3 or higher won't appear in the web-interface. 
	They only get logged in the specified log-file (see <a href="#synopsis">Synopsis</a>).
      </p>
      <hr>
      <div align=right>
	<i>
	  <!-- hhmts start -->
		  Latest modification: 16 Jan 02 11:14:40 Thomas Birke
		  <!-- hhmts end -->
	</i>
	<address>
	  <a href="mailto:birke@lanl.gov">birke@lanl.gov</a>
	</address>
      </div>
      <hr>
  </body>

</html>
